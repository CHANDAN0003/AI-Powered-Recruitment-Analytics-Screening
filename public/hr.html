<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Dashboard - TalentConnect</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dashboard-body">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-users-cog"></i>
                <span>TalentConnect</span>
            </div>
            <div class="user-menu">
                <span class="user-name">Welcome, HR Manager</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1><i class="fas fa-chart-line"></i> HR Dashboard</h1>
                <p>Manage recruitment and track applicant insights</p>
            </div>

            <!-- Dashboard Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalApplicants">--</h3>
                        <p>Total Applicants</p>
                        <small class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="totalApplicantsChange">--</span>
                        </small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="recentApplicants">--</h3>
                        <p>Last 24 Hours</p>
                        <small class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="recentApplicantsChange">--</span>
                        </small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="eligibleApplicants">--</h3>
                        <p>Eligible Candidates</p>
                        <small class="stat-subtext">Based on ML predictions</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="conversionRate">--%</h3>
                        <p>Conversion Rate</p>
                        <small class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="conversionRateChange">--</span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-section">
                <button class="btn-primary" id="sendEmailsBtn" onclick="sendPersonalizedEmails()">
                    <i class="fas fa-envelope-bulk"></i>
                    <span class="btn-text">Send Personalized Emails</span>
                    <i class="fas fa-spinner fa-spin" id="emailSpinner" style="display: none;"></i>
                </button>
                <button class="btn-secondary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
            </div>

            <!-- Applicants Management -->
            <div class="section-card">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Manage Applicants</h2>
                    <div class="section-actions">
                        <button class="btn-outline" onclick="exportApplicants()">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="search-filters">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="applicantSearch" placeholder="Search by name, email, or skills...">
                    </div>
                    <div class="filter-options">
                        <select id="skillFilter">
                            <option value="">Filter by Skills</option>
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="react">React</option>
                            <option value="nodejs">Node.js</option>
                            <option value="java">Java</option>
                        </select>
                        <select id="experienceFilter">
                            <option value="">Filter by Experience</option>
                            <option value="0-1">0-1 years</option>
                            <option value="2-5">2-5 years</option>
                            <option value="5-10">5-10 years</option>
                            <option value="10+">10+ years</option>
                        </select>
                        <select id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="new">New</option>
                            <option value="reviewed">Reviewed</option>
                            <option value="shortlisted">Shortlisted</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>

                <!-- Applicants Table -->
                <div class="table-container">
                    <table class="applicants-table" id="applicantsTable">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th>Skills</th>
                                <th>Experience</th>
                                <th>Status</th>
                                <th>Applied Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applicantsTableBody">
                            <!-- Applicants will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <button class="page-btn" id="prevPage" onclick="changePage(-1)">
                        <i class="fas fa-chevron-left"></i>
                        Previous
                    </button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button class="page-btn" id="nextPage" onclick="changePage(1)">
                        Next
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Applicant Details Modal -->
    <div class="modal" id="applicantModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> Applicant Details</h2>
                <button class="modal-close" onclick="closeApplicantModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="applicantDetails">
                <!-- Applicant details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <script src="app.js"></script>
    <script>
        // HR Dashboard specific functionality
        let currentPage = 1;
        let applicantsData = [];
        let filteredApplicants = [];
        const itemsPerPage = 10;

        // Initialize HR Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth('hr')) return;
            
            loadDashboardData();
            loadApplicants();
            
            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('applicantSearch').addEventListener('input', filterApplicants);
            document.getElementById('skillFilter').addEventListener('change', filterApplicants);
            document.getElementById('experienceFilter').addEventListener('change', filterApplicants);
            document.getElementById('statusFilter').addEventListener('change', filterApplicants);
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
        }

        async function loadDashboardData() {
            try {
                showToast('Loading dashboard data...', 'info');
                const response = await fetch('/api/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateDashboardStats(data);
                } else {
                    // Use mock data for demo
                    const mockData = {
                        totalApplicants: 156,
                        totalApplicantsChange: '+12%',
                        recentApplicants: 23,
                        recentApplicantsChange: '+8%',
                        eligibleApplicants: 89,
                        conversionRate: 57,
                        conversionRateChange: '+3%'
                    };
                    updateDashboardStats(mockData);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }

        function updateDashboardStats(data) {
            document.getElementById('totalApplicants').textContent = data.totalApplicants;
            document.getElementById('totalApplicantsChange').textContent = data.totalApplicantsChange || '+5%';
            document.getElementById('recentApplicants').textContent = data.recentApplicants;
            document.getElementById('recentApplicantsChange').textContent = data.recentApplicantsChange || '+3%';
            document.getElementById('eligibleApplicants').textContent = data.eligibleApplicants;
            document.getElementById('conversionRate').textContent = data.conversionRate + '%';
            document.getElementById('conversionRateChange').textContent = data.conversionRateChange || '+2%';
        }

        async function loadApplicants() {
            try {
                const response = await fetch('/api/applicants', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    applicantsData = await response.json();
                } else {
                    // Use mock data for demo
                    applicantsData = generateMockApplicants();
                }
                
                filteredApplicants = [...applicantsData];
                displayApplicants();
                updatePagination();
            } catch (error) {
                console.error('Error loading applicants:', error);
                applicantsData = generateMockApplicants();
                filteredApplicants = [...applicantsData];
                displayApplicants();
                updatePagination();
            }
        }

        function generateMockApplicants() {
            const mockApplicants = [];
            const names = ['John Doe', 'Jane Smith', 'Mike Johnson', 'Sarah Wilson', 'David Brown', 'Lisa Garcia', 'Tom Anderson', 'Emma Davis'];
            const positions = ['Frontend Developer', 'Backend Developer', 'Full Stack Developer', 'UI/UX Designer', 'Data Analyst'];
            const skills = [
                ['JavaScript', 'React', 'CSS'],
                ['Python', 'Django', 'PostgreSQL'],
                ['Node.js', 'MongoDB', 'Express'],
                ['Figma', 'Adobe XD', 'Sketch'],
                ['Python', 'pandas', 'SQL']
            ];
            const experiences = ['0-1', '2-5', '5-10', '10+'];
            const statuses = ['new', 'reviewed', 'shortlisted', 'rejected'];

            for (let i = 0; i < 25; i++) {
                const randomName = names[Math.floor(Math.random() * names.length)];
                const randomPosition = positions[Math.floor(Math.random() * positions.length)];
                const randomSkills = skills[Math.floor(Math.random() * skills.length)];
                const randomExperience = experiences[Math.floor(Math.random() * experiences.length)];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                
                mockApplicants.push({
                    id: i + 1,
                    name: `${randomName} ${i + 1}`,
                    email: `${randomName.toLowerCase().replace(' ', '.')}${i + 1}@email.com`,
                    position: randomPosition,
                    skills: randomSkills,
                    experience: randomExperience,
                    status: randomStatus,
                    appliedDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    resume: 'resume.pdf',
                    phone: '+1234567890',
                    coverLetter: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit...'
                });
            }
            
            return mockApplicants;
        }

        function displayApplicants() {
            const tbody = document.getElementById('applicantsTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentApplicants = filteredApplicants.slice(startIndex, endIndex);

            tbody.innerHTML = currentApplicants.map(applicant => `
                <tr>
                    <td><input type="checkbox" class="applicant-checkbox" value="${applicant.id}"></td>
                    <td>
                        <div class="applicant-name">
                            <strong>${applicant.name}</strong>
                        </div>
                    </td>
                    <td>${applicant.email}</td>
                    <td><span class="position-badge">${applicant.position}</span></td>
                    <td>
                        <div class="skills-list">
                            ${applicant.skills.slice(0, 2).map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                            ${applicant.skills.length > 2 ? `<span class="skill-more">+${applicant.skills.length - 2}</span>` : ''}
                        </div>
                    </td>
                    <td>${applicant.experience} years</td>
                    <td><span class="status-badge status-${applicant.status}">${applicant.status}</span></td>
                    <td>${applicant.appliedDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="viewApplicant(${applicant.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon" onclick="downloadResume(${applicant.id})" title="Download Resume">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-icon" onclick="updateStatus(${applicant.id}, 'shortlisted')" title="Shortlist">
                                <i class="fas fa-star"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterApplicants() {
            const searchTerm = document.getElementById('applicantSearch').value.toLowerCase();
            const skillFilter = document.getElementById('skillFilter').value;
            const experienceFilter = document.getElementById('experienceFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredApplicants = applicantsData.filter(applicant => {
                const matchesSearch = !searchTerm || 
                    applicant.name.toLowerCase().includes(searchTerm) ||
                    applicant.email.toLowerCase().includes(searchTerm) ||
                    applicant.skills.some(skill => skill.toLowerCase().includes(searchTerm));
                
                const matchesSkill = !skillFilter || 
                    applicant.skills.some(skill => skill.toLowerCase().includes(skillFilter));
                
                const matchesExperience = !experienceFilter || applicant.experience === experienceFilter;
                const matchesStatus = !statusFilter || applicant.status === statusFilter;

                return matchesSearch && matchesSkill && matchesExperience && matchesStatus;
            });

            currentPage = 1;
            displayApplicants();
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredApplicants.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredApplicants.length / itemsPerPage);
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            displayApplicants();
            updatePagination();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.applicant-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function viewApplicant(id) {
            const applicant = applicantsData.find(a => a.id === id);
            if (!applicant) return;

            const modalBody = document.getElementById('applicantDetails');
            modalBody.innerHTML = `
                <div class="applicant-profile">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="profile-info">
                            <h3>${applicant.name}</h3>
                            <p>${applicant.email}</p>
                            <p>${applicant.phone}</p>
                            <span class="status-badge status-${applicant.status}">${applicant.status}</span>
                        </div>
                    </div>
                    
                    <div class="profile-details">
                        <div class="detail-section">
                            <h4><i class="fas fa-briefcase"></i> Position Applied</h4>
                            <p>${applicant.position}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4><i class="fas fa-tools"></i> Skills</h4>
                            <div class="skills-list">
                                ${applicant.skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4><i class="fas fa-chart-line"></i> Experience</h4>
                            <p>${applicant.experience} years</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4><i class="fas fa-calendar"></i> Application Date</h4>
                            <p>${applicant.appliedDate}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4><i class="fas fa-file-alt"></i> Cover Letter</h4>
                            <p>${applicant.coverLetter}</p>
                        </div>
                    </div>
                    
                    <div class="profile-actions">
                        <button class="btn-primary" onclick="updateStatus(${applicant.id}, 'shortlisted')">
                            <i class="fas fa-star"></i>
                            Shortlist
                        </button>
                        <button class="btn-secondary" onclick="downloadResume(${applicant.id})">
                            <i class="fas fa-download"></i>
                            Download Resume
                        </button>
                        <button class="btn-danger" onclick="updateStatus(${applicant.id}, 'rejected')">
                            <i class="fas fa-times"></i>
                            Reject
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('applicantModal').classList.add('active');
        }

        function closeApplicantModal() {
            document.getElementById('applicantModal').classList.remove('active');
        }

        function updateStatus(id, status) {
            const applicant = applicantsData.find(a => a.id === id);
            if (applicant) {
                applicant.status = status;
                displayApplicants();
                showToast(`Applicant status updated to ${status}`, 'success');
                closeApplicantModal();
            }
        }

        function downloadResume(id) {
            const applicant = applicantsData.find(a => a.id === id);
            if (applicant) {
                showToast(`Downloading resume for ${applicant.name}`, 'info');
                // In a real application, this would trigger an actual download
            }
        }

        async function sendPersonalizedEmails() {
            const btn = document.getElementById('sendEmailsBtn');
            const btnText = btn.querySelector('.btn-text');
            const spinner = document.getElementById('emailSpinner');
            
            btnText.textContent = 'Sending Emails...';
            spinner.style.display = 'inline-block';
            btn.disabled = true;

            try {
                const response = await fetch('/api/send_email', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        applicantIds: getSelectedApplicants()
                    })
                });

                if (response.ok) {
                    showToast('Personalized emails sent successfully!', 'success');
                } else {
                    // Demo: simulate success
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    showToast('Personalized emails sent successfully!', 'success');
                }
            } catch (error) {
                console.error('Error sending emails:', error);
                // Demo: simulate success
                await new Promise(resolve => setTimeout(resolve, 2000));
                showToast('Personalized emails sent successfully!', 'success');
            } finally {
                btnText.textContent = 'Send Personalized Emails';
                spinner.style.display = 'none';
                btn.disabled = false;
            }
        }

        function getSelectedApplicants() {
            const checkboxes = document.querySelectorAll('.applicant-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        function refreshDashboard() {
            showToast('Refreshing dashboard data...', 'info');
            loadDashboardData();
            loadApplicants();
        }

        function exportApplicants() {
            const csvContent = generateCSV(filteredApplicants);
            downloadCSV(csvContent, 'applicants.csv');
            showToast('Applicants data exported successfully!', 'success');
        }

        function generateCSV(data) {
            const headers = ['Name', 'Email', 'Position', 'Skills', 'Experience', 'Status', 'Applied Date'];
            const csvRows = [headers.join(',')];
            
            data.forEach(applicant => {
                const row = [
                    applicant.name,
                    applicant.email,
                    applicant.position,
                    `"${applicant.skills.join(', ')}"`,
                    applicant.experience,
                    applicant.status,
                    applicant.appliedDate
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>